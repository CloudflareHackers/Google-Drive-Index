// Google Drive Index â€” Material Design 3 Frontend
(function(){
'use strict';
const S={setupComplete:false,auth:false,user:null,cfg:{},drives:[],di:0,folder:'root',stack:[],files:[],npt:null,loading:false,q:'',sr:[],page:'loading',aTab:'drives',aDrives:[],aCfg:{},err:null};
const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s);
const E=s=>s==null?'':String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
async function api(p,o={}){const h={'Content-Type':'application/json',...o.headers};const r=await fetch('/api/'+p,{...o,headers:h});const d=await r.json();if(!r.ok)throw new Error(d.error||'Failed');return d}
function fmtSz(b){if(!b)return'\u2014';const s=parseInt(b);if(isNaN(s))return'\u2014';const u=['B','KB','MB','GB','TB'];let i=0,v=s;while(v>=1024&&i<u.length-1){v/=1024;i++}return v.toFixed(i?1:0)+' '+u[i]}
function fmtDt(d){if(!d)return'\u2014';return new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}
function fIco(m,f){if(f)return'<span class="material-icons-outlined folder-icon">folder</span>';if(!m)return'<span class="material-icons-outlined default-icon">description</span>';if(m.startsWith('image/'))return'<span class="material-icons-outlined img-icon">image</span>';if(m.startsWith('video/'))return'<span class="material-icons-outlined vid-icon">movie</span>';if(m.startsWith('audio/'))return'<span class="material-icons-outlined aud-icon">audiotrack</span>';if(m==='application/pdf')return'<span class="material-icons-outlined pdf-icon">picture_as_pdf</span>';if(m.includes('zip')||m.includes('archive'))return'<span class="material-icons-outlined zip-icon">folder_zip</span>';if(m.includes('spreadsheet'))return'<span class="material-icons-outlined sheet-icon">table_chart</span>';if(m.includes('document')||m.includes('word'))return'<span class="material-icons-outlined doc-icon">article</span>';if(m.includes('presentation'))return'<span class="material-icons-outlined" style="color:#e37400">slideshow</span>';return'<span class="material-icons-outlined default-icon">description</span>'}
function nav(p){history.pushState(null,'',p);route();render()}
function route(){const p=location.pathname;if(p.startsWith('/login'))S.page='login';else if(p.startsWith('/admin'))S.page='admin';else if(p.startsWith('/search')){S.page='search';S.q=new URLSearchParams(location.search).get('q')||''}else S.page='home'}
window.addEventListener('popstate',()=>{route();render()});
async function init(){S.page='loading';render();try{const d=await api('status');S.setupComplete=d.setup_complete;S.auth=d.authenticated;S.user=d.username;S.cfg=d.config||{};S.drives=d.drives||[];if(!S.setupComplete)S.page='setup';else{route();if(S.page==='home'){S.di=0;S.folder='root';S.stack=[]}}}catch(e){S.page='setup'}render();if(S.page==='home'&&S.drives.length>0)loadFiles();if(S.page==='search'&&S.q)doSearch();if(S.page==='admin')loadAdmin()}
async function loadFiles(){S.loading=true;S.err=null;render();try{const p=new URLSearchParams({drive:S.di,folder:S.folder});if(S.npt)p.set('pageToken',S.npt);const d=await api('files?'+p);S.files=d.files||[];S.npt=d.nextPageToken}catch(e){S.err=e.message;S.files=[]}S.loading=false;render()}
async function doSearch(){S.loading=true;S.err=null;render();try{const d=await api('search?q='+encodeURIComponent(S.q));S.sr=d.results||[]}catch(e){S.err=e.message;S.sr=[]}S.loading=false;render()}
async function loadAdmin(){try{const[a,b]=await Promise.all([api('admin/drives').catch(()=>({drives:[]})),api('admin/config').catch(()=>({config:{}}))]);S.aDrives=a.drives||[];S.aCfg=b.config||{}}catch(e){}render()}
function openFolder(f){S.stack.push({id:S.folder,name:S.stack.length?S.stack[S.stack.length-1].name:'Root'});S.folder=f.id;S.stack.push({id:f.id,name:f.name});S.npt=null;loadFiles()}
function goTo(i){if(i===-1){S.folder='root';S.stack=[]}else{S.folder=S.stack[i].id;S.stack=S.stack.slice(0,i+1)}S.npt=null;loadFiles()}
function switchDrive(i){S.di=i;S.folder='root';S.stack=[];S.npt=null;loadFiles()}
function render(){const a=$('#app');if(!a)return;switch(S.page){case'loading':a.innerHTML=rLoading();break;case'setup':a.innerHTML=rSetup();bSetup();break;case'login':a.innerHTML=rLogin();bLogin();break;case'home':a.innerHTML=rHome();bHome();break;case'search':a.innerHTML=rSearch();bSearch();break;case'admin':a.innerHTML=rAdmin();bAdmin();break;default:a.innerHTML=rLoading()}}
function rLoading(){return'<div class="loading-state"><div class="md-spinner"></div><p style="margin-top:24px;font-size:14px">Loading...</p></div>'}
// === SETUP ===
function rSetup(){return'<div class="center-page"><div class="auth-card"><h1>Welcome</h1><p class="subtitle">Create your admin account to get started with Google Drive Index.</p><div id="se"></div><div class="md-field"><label>Username</label><input id="su" type="text" placeholder="Choose a username"></div><div class="md-field"><label>Password</label><input id="sp" type="password" placeholder="Create a strong password"><div class="pw-check" id="pc"></div></div><div class="md-field"><label>Confirm password</label><input id="sp2" type="password" placeholder="Repeat your password"></div><button class="md-filled-btn" id="sb" style="width:100%"><span class="material-icons-outlined" style="font-size:18px">person_add</span> Create account</button></div></div>'}
function bSetup(){const b=$('#sb'),p=$('#sp');if(p)p.oninput=()=>{const v=p.value,r=$('#pc');if(!r)return;r.innerHTML=[v.length>=8?'<span class="ok">\u2713 8+ chars</span>':'<span class="no">\u2717 8+ chars</span>',/[A-Z]/.test(v)?'<span class="ok">\u2713 Uppercase</span>':'<span class="no">\u2717 Uppercase</span>',/[a-z]/.test(v)?'<span class="ok">\u2713 Lowercase</span>':'<span class="no">\u2717 Lowercase</span>',/[0-9]/.test(v)?'<span class="ok">\u2713 Number</span>':'<span class="no">\u2717 Number</span>',/[^A-Za-z0-9]/.test(v)?'<span class="ok">\u2713 Special</span>':'<span class="no">\u2717 Special</span>'].join('')};if(b)b.onclick=async()=>{const u=$('#su').value.trim(),pw=$('#sp').value,p2=$('#sp2').value,e=$('#se');e.innerHTML='';if(!u||u.length<3){e.innerHTML='<div class="alert-error"><span class="material-icons-outlined" style="font-size:18px">error</span> Username must be at least 3 characters</div>';return}if(pw!==p2){e.innerHTML='<div class="alert-error"><span class="material-icons-outlined" style="font-size:18px">error</span> Passwords do not match</div>';return}b.disabled=true;try{await api('setup',{method:'POST',body:JSON.stringify({username:u,password:pw})});e.innerHTML='<div class="alert-success">Account created! Redirecting to sign in...</div>';setTimeout(()=>{S.setupComplete=true;S.page='login';render()},1500)}catch(x){e.innerHTML='<div class="alert-error"><span class="material-icons-outlined" style="font-size:18px">error</span> '+E(x.message)+'</div>';b.disabled=false}}}
// === LOGIN ===
function rLogin(){return'<div class="center-page"><div class="auth-card"><h1>Sign in</h1><p class="subtitle">Use your admin account to continue.</p><div id="le"></div><div class="md-field"><label>Username</label><input id="lu" type="text" placeholder="Username"></div><div class="md-field"><label>Password</label><input id="lp" type="password" placeholder="Password"></div><button class="md-filled-btn" id="lb" style="width:100%"><span class="material-icons-outlined" style="font-size:18px">login</span> Sign in</button></div></div>'}
function bLogin(){const b=$('#lb');if(b)b.onclick=async()=>{const u=$('#lu').value.trim(),p=$('#lp').value,e=$('#le');e.innerHTML='';if(!u||!p){e.innerHTML='<div class="alert-error"><span class="material-icons-outlined" style="font-size:18px">error</span> Enter your credentials</div>';return}b.disabled=true;try{await api('login',{method:'POST',body:JSON.stringify({username:u,password:p})});S.auth=true;S.user=u;nav('/');init()}catch(x){e.innerHTML='<div class="alert-error"><span class="material-icons-outlined" style="font-size:18px">error</span> '+E(x.message)+'</div>';b.disabled=false}};const p=$('#lp');if(p)p.onkeydown=e=>{if(e.key==='Enter'&&b)b.click()}}
// === TOP BAR ===
function rBar(){const n=S.cfg.site_name||'Google Drive Index';return'<div class="top-bar"><div class="brand"><span class="material-icons-outlined">cloud</span>'+E(n)+'</div>'+(S.cfg.allow_search!==false?'<div class="search-bar"><span class="material-icons-outlined">search</span><input id="ns" type="text" placeholder="Search in Drive" value="'+E(S.q)+'"></div>':'<div class="spacer"></div>')+(S.auth?'<button class="icon-btn" id="na" title="Admin"><span class="material-icons-outlined">settings</span></button>':'')+( S.auth?'<button class="icon-btn" id="nl" title="Sign out"><span class="material-icons-outlined">logout</span></button>':'')+(!S.auth&&S.cfg.auth_enabled?'<button class="icon-btn" id="nli" title="Sign in"><span class="material-icons-outlined">login</span></button>':'')+'</div>'}
// === BREADCRUMBS ===
function rBC(){let h='<div class="breadcrumbs"><a href="#" data-bc="-1"><span class="material-icons-outlined" style="font-size:18px;vertical-align:middle">home</span> Home</a>';const seen=new Set();S.stack.forEach((item,i)=>{if(!seen.has(item.id)){seen.add(item.id);h+='<span class="sep">\u203A</span>';if(i===S.stack.length-1)h+='<span class="current">'+E(item.name)+'</span>';else h+='<a href="#" data-bc="'+i+'">'+E(item.name)+'</a>'}});return h+'</div>'}
// === HOME ===
function rHome(){let h=rBar()+'<div class="content">';if(!S.drives.length){h+='<div class="empty-state"><span class="material-icons-outlined">inbox</span><h3 style="font-family:var(--md-sys-typescale-display-font);font-weight:400">No drives configured</h3><p>'+(S.auth?'Go to <a href="/admin">Admin Panel</a> to add your first drive.':'Contact the administrator.')+'</p></div></div>';return h}if(S.folder==='root'&&!S.stack.length){h+='<div style="padding:8px 0 16px"><span style="font-size:14px;color:var(--md-sys-color-on-surface-variant)">Your drives</span></div><div class="drives-grid">';S.drives.forEach((d,i)=>{h+='<div class="drive-card" data-drive="'+i+'"><div class="card-icon"><span class="material-icons-outlined">hard_drive</span></div><div class="card-text"><div class="card-title">'+E(d.name)+'</div><div class="card-sub">Google Drive</div></div></div>'});h+='</div><div class="status-bar">'+S.drives.length+' drive'+(S.drives.length!==1?'s':'')+'</div></div>';return h}h+=rBC();if(S.loading){h+='<div class="loading-state"><div class="md-spinner"></div></div></div>';return h}if(S.err){h+='<div class="alert-error"><span class="material-icons-outlined" style="font-size:18px">error</span> '+E(S.err)+'</div></div>';return h}if(!S.files.length){h+='<div class="empty-state"><span class="material-icons-outlined">folder_open</span><h3 style="font-family:var(--md-sys-typescale-display-font);font-weight:400">This folder is empty</h3></div></div>';return h}h+='<div class="file-list"><div class="file-list-header"><div>Name</div><div>Size</div><div>Modified</div><div></div></div>';S.files.forEach((f,i)=>{h+='<div class="file-row" data-idx="'+i+'"><div class="file-name">'+fIco(f.mimeType,f.isFolder)+'<span>'+E(f.name)+'</span></div><div class="file-size">'+fmtSz(f.size)+'</div><div class="file-date">'+fmtDt(f.modifiedTime)+'</div><div>'+(f.isFolder?'':'<button class="icon-btn dl-btn" data-idx="'+i+'" title="Download"><span class="material-icons-outlined" style="font-size:20px">download</span></button>')+'</div></div>'});h+='</div>';if(S.npt)h+='<div style="text-align:center;padding:20px"><button class="md-outlined-btn" id="loadmore"><span class="material-icons-outlined" style="font-size:18px">expand_more</span> Load more</button></div>';h+='<div class="status-bar">'+S.files.length+' item'+(S.files.length!==1?'s':'')+'</div></div>';return h}
function bHome(){$$('.drive-card').forEach(c=>c.onclick=()=>switchDrive(+c.dataset.drive));$$('.file-row').forEach(c=>{c.onclick=()=>{const f=S.files[+c.dataset.idx];if(f&&f.isFolder)openFolder(f)}});$$('.dl-btn').forEach(b=>{b.onclick=e=>{e.stopPropagation();const f=S.files[+b.dataset.idx];if(f)window.open('/download/'+S.di+'/'+f.id,'_blank')}});$$('[data-bc]').forEach(a=>{a.onclick=e=>{e.preventDefault();goTo(+a.dataset.bc)}});const lm=$('#loadmore');if(lm)lm.onclick=()=>loadFiles();const ns=$('#ns');if(ns)ns.onkeydown=e=>{if(e.key==='Enter'&&ns.value.trim()){S.q=ns.value.trim();nav('/search?q='+encodeURIComponent(S.q));doSearch()}};const na=$('#na');if(na)na.onclick=()=>nav('/admin');const nl=$('#nl');if(nl)nl.onclick=async()=>{try{await api('logout',{method:'POST'})}catch(e){}S.auth=false;S.user=null;init()};const nli=$('#nli');if(nli)nli.onclick=()=>nav('/login')}
// === SEARCH ===
function rSearch(){let h=rBar()+'<div class="content"><div style="padding:8px 0 16px"><span style="font-size:14px;color:var(--md-sys-color-on-surface-variant)">Search results for</span> <strong>'+E(S.q)+'</strong></div>';if(S.loading){h+='<div class="loading-state"><div class="md-spinner"></div></div></div>';return h}if(S.err){h+='<div class="alert-error">'+E(S.err)+'</div></div>';return h}if(!S.sr.length){h+='<div class="empty-state"><span class="material-icons-outlined">search_off</span><h3 style="font-family:var(--md-sys-typescale-display-font);font-weight:400">No results found</h3><p>Try different keywords</p></div></div>';return h}h+='<div class="file-list"><div class="file-list-header"><div>Name</div><div>Size</div><div>Drive</div><div></div></div>';S.sr.forEach((f,i)=>{h+='<div class="file-row" data-si="'+i+'"><div class="file-name">'+fIco(f.mimeType,f.isFolder)+'<span>'+E(f.name)+'</span></div><div class="file-size">'+fmtSz(f.size)+'</div><div class="file-date" style="font-size:12px">'+E(f.driveName)+'</div><div>'+(f.isFolder?'':'<button class="icon-btn sdl" data-si="'+i+'"><span class="material-icons-outlined" style="font-size:20px">download</span></button>')+'</div></div>'});h+='</div><div class="status-bar">'+S.sr.length+' result'+(S.sr.length!==1?'s':'')+'</div></div>';return h}
function bSearch(){bHome();$$('.sdl').forEach(b=>{b.onclick=e=>{e.stopPropagation();const f=S.sr[+b.dataset.si];if(f)window.open('/download/'+f.driveIndex+'/'+f.id,'_blank')}})}
// === ADMIN ===
function rAdmin(){if(!S.auth)return rLogin();let h='<div class="admin-rail"><div class="rail-brand"><span class="material-icons-outlined">admin_panel_settings</span><span>Admin</span></div><nav>';[['drives','hard_drive','Drives'],['config','tune','Config'],['password','key','Password']].forEach(([k,ic,lb])=>{h+='<a href="#" data-at="'+k+'" class="'+(S.aTab===k?'active':'')+'"><span class="material-icons-outlined">'+ic+'</span><span>'+lb+'</span></a>'});h+='</nav><div class="rail-footer"><a href="#" id="ab"><span class="material-icons-outlined" style="font-size:18px">arrow_back</span> <span>Back to site</span></a><br><a href="#" id="alo" style="color:var(--md-sys-color-error)"><span class="material-icons-outlined" style="font-size:18px">logout</span> <span>Sign out</span></a></div></div><div class="admin-body">';if(S.aTab==='drives')h+=rAD();else if(S.aTab==='config')h+=rAC();else if(S.aTab==='password')h+=rAP();h+='</div>';return h}
function rAD(){let h='<h2><span class="material-icons-outlined">hard_drive</span> Drives</h2><div style="margin-bottom:16px"><button class="md-filled-btn" id="add-drive"><span class="material-icons-outlined" style="font-size:18px">add</span> Add drive</button></div>';if(!S.aDrives.length)h+='<div class="empty-state"><span class="material-icons-outlined">inbox</span><p>No drives configured yet.</p></div>';else{h+='<table class="md-table"><thead><tr><th>ID</th><th>Name</th><th>Root Folder</th><th>Status</th><th></th></tr></thead><tbody>';S.aDrives.forEach(d=>{h+='<tr><td>'+d.id+'</td><td><strong>'+E(d.name)+'</strong></td><td><code style="font-size:12px;color:var(--md-sys-color-on-surface-variant)">'+E(d.root_folder_id)+'</code></td><td>'+(d.enabled?'<span class="chip-on">Enabled</span>':'<span class="chip-off">Disabled</span>')+'</td><td><button class="icon-btn del-d" data-id="'+d.id+'" title="Delete"><span class="material-icons-outlined" style="font-size:18px;color:var(--md-sys-color-error)">delete</span></button></td></tr>'});h+='</tbody></table>'}return h}
function rAC(){let h='<h2><span class="material-icons-outlined">tune</span> Configuration</h2><div id="acm"></div>';const ks=Object.keys(S.aCfg).sort();if(!ks.length)h+='<p style="color:var(--md-sys-color-on-surface-variant)">No configuration entries.</p>';else{h+='<table class="md-table"><thead><tr><th>Key</th><th>Value</th></tr></thead><tbody>';ks.forEach(k=>{h+='<tr><td><code style="font-size:13px">'+E(k)+'</code></td><td><input class="cv" data-key="'+E(k)+'" value="'+E(S.aCfg[k])+'" style="width:100%;padding:8px 12px;background:var(--md-sys-color-surface-container);border:1px solid var(--md-sys-color-outline-variant);border-radius:4px;color:var(--md-sys-color-on-surface);font-size:14px;outline:none"></td></tr>'});h+='</tbody></table><div style="margin-top:16px"><button class="md-filled-btn" id="save-cfg"><span class="material-icons-outlined" style="font-size:18px">save</span> Save changes</button></div>'}return h}
function rAP(){return'<h2><span class="material-icons-outlined">key</span> Change Password</h2><div style="max-width:400px"><div id="pe"></div><div class="md-field"><label>Current password</label><input id="cp" type="password"></div><div class="md-field"><label>New password</label><input id="np" type="password"></div><button class="md-filled-btn" id="chpw"><span class="material-icons-outlined" style="font-size:18px">lock_reset</span> Update password</button></div>'}
function bAdmin(){$$('[data-at]').forEach(a=>{a.onclick=e=>{e.preventDefault();S.aTab=a.dataset.at;render()}});const ab=$('#ab');if(ab)ab.onclick=e=>{e.preventDefault();nav('/')};const alo=$('#alo');if(alo)alo.onclick=async e=>{e.preventDefault();try{await api('logout',{method:'POST'})}catch(x){}S.auth=false;nav('/login')};const ad=$('#add-drive');if(ad)ad.onclick=()=>{const n=prompt('Drive name:');if(!n)return;const ci=prompt('Client ID:');if(!ci)return;const cs=prompt('Client Secret:');if(!cs)return;const rt=prompt('Refresh Token:');if(!rt)return;const rf=prompt('Root Folder ID (or "root"):','root');api('admin/drives',{method:'POST',body:JSON.stringify({name:n,client_id:ci,client_secret:cs,refresh_token:rt,root_folder_id:rf||'root'})}).then(()=>{loadAdmin()}).catch(e=>alert(e.message))};$$('.del-d').forEach(b=>{b.onclick=()=>{if(!confirm('Delete this drive?'))return;api('admin/drives?id='+b.dataset.id,{method:'DELETE'}).then(()=>loadAdmin()).catch(e=>alert(e.message))}});const sc=$('#save-cfg');if(sc)sc.onclick=async()=>{const body={};$$('.cv').forEach(el=>{body[el.dataset.key]=el.value});try{await api('admin/config',{method:'POST',body:JSON.stringify(body)});alert('Configuration saved!')}catch(e){alert(e.message)}};const ch=$('#chpw');if(ch)ch.onclick=async()=>{const cp=$('#cp').value,np=$('#np').value,pe=$('#pe');pe.innerHTML='';if(!cp||!np){pe.innerHTML='<div class="alert-error">Both fields are required</div>';return}try{await api('admin/password',{method:'POST',body:JSON.stringify({current_password:cp,new_password:np})});pe.innerHTML='<div class="alert-success">Password updated. Please sign in again.</div>';setTimeout(()=>nav('/login'),2000)}catch(e){pe.innerHTML='<div class="alert-error">'+E(e.message)+'</div>'}}}
init();
})();