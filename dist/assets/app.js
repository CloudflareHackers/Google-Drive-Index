// Google Drive Index â€” Material Design 3 Frontend
(function(){
'use strict';
var S={setupComplete:false,auth:false,user:null,cfg:{},drives:[],di:0,folder:'root',stack:[],files:[],npt:null,loading:false,q:'',sr:[],page:'loading',aTab:'drives',aDrives:[],aCfg:{},err:null,showAdd:false};
var $=function(s){return document.querySelector(s)};
var $$=function(s){return document.querySelectorAll(s)};
function E(s){return s==null?'':String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function api(p,o){o=o||{};var h=Object.assign({'Content-Type':'application/json'},o.headers||{});return fetch('/api/'+p,Object.assign({},o,{headers:h})).then(function(r){return r.json().then(function(d){if(!r.ok)throw new Error(d.error||'Failed');return d})})}
function fSz(b){if(!b)return'\u2014';var s=parseInt(b);if(isNaN(s))return'\u2014';var u=['B','KB','MB','GB','TB'],i=0,v=s;while(v>=1024&&i<u.length-1){v/=1024;i++}return v.toFixed(i?1:0)+' '+u[i]}
function fDt(d){if(!d)return'\u2014';return new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}
function fI(m,f){if(f)return'<span class="material-icons-outlined folder-icon">folder</span>';if(!m)return'<span class="material-icons-outlined default-icon">description</span>';if(m.startsWith('image/'))return'<span class="material-icons-outlined img-icon">image</span>';if(m.startsWith('video/'))return'<span class="material-icons-outlined vid-icon">movie</span>';if(m.startsWith('audio/'))return'<span class="material-icons-outlined aud-icon">audiotrack</span>';if(m==='application/pdf')return'<span class="material-icons-outlined pdf-icon">picture_as_pdf</span>';if(m.indexOf('zip')>-1||m.indexOf('archive')>-1)return'<span class="material-icons-outlined zip-icon">folder_zip</span>';if(m.indexOf('sheet')>-1)return'<span class="material-icons-outlined sheet-icon">table_chart</span>';if(m.indexOf('doc')>-1)return'<span class="material-icons-outlined doc-icon">article</span>';return'<span class="material-icons-outlined default-icon">description</span>'}
function go(p){history.pushState(null,'',p);rt();R();if(S.page==='admin')lA();if(S.page==='search'&&S.q)dS()}
function rt(){var p=location.pathname;if(p.indexOf('/login')===0)S.page='login';else if(p.indexOf('/admin')===0)S.page='admin';else if(p.indexOf('/search')===0){S.page='search';S.q=(new URLSearchParams(location.search)).get('q')||''}else S.page='home'}
window.addEventListener('popstate',function(){rt();R()});
function init(){S.page='loading';R();api('status').then(function(d){S.setupComplete=d.setup_complete;S.auth=d.authenticated;S.user=d.username;S.cfg=d.config||{};S.drives=d.drives||[];if(!S.setupComplete){S.page='setup'}else{rt();if(S.page==='home'){S.di=0;S.folder='root';S.stack=[]}}R();if(S.page==='home'&&S.drives.length>0)lF();if(S.page==='search'&&S.q)dS();if(S.page==='admin')lA()}).catch(function(){S.page='setup';R()})}
function lF(){S.loading=true;S.err=null;R();var p=new URLSearchParams({drive:S.di,folder:S.folder});if(S.npt)p.set('pageToken',S.npt);api('files?'+p).then(function(d){S.files=d.files||[];S.npt=d.nextPageToken;S.loading=false;R()}).catch(function(e){S.err=e.message;S.files=[];S.loading=false;R()})}
function dS(){S.loading=true;S.err=null;R();api('search?q='+encodeURIComponent(S.q)).then(function(d){S.sr=d.results||[];S.loading=false;R()}).catch(function(e){S.err=e.message;S.sr=[];S.loading=false;R()})}
function lA(){Promise.all([api('admin/drives').catch(function(){return{drives:[]}}),api('admin/config').catch(function(){return{config:{}}})]).then(function(r){S.aDrives=r[0].drives||[];S.aCfg=r[1].config||{};R()})}
function oF(f){S.stack.push({id:S.folder,name:S.stack.length?S.stack[S.stack.length-1].name:'Root'});S.folder=f.id;S.stack.push({id:f.id,name:f.name});S.npt=null;lF()}
function gT(i){if(i===-1){S.folder='root';S.stack=[]}else{S.folder=S.stack[i].id;S.stack=S.stack.slice(0,i+1)}S.npt=null;lF()}
function sD(i){S.di=i;S.folder='root';S.stack=[];S.npt=null;lF()}
function R(){var a=$('#app');if(!a)return;var h='';switch(S.page){case'loading':h=rL();break;case'setup':h=rS();break;case'login':h=rLi();break;case'home':h=rH();break;case'search':h=rSe();break;case'admin':h=rAd();break;default:h=rL()}a.innerHTML=h;B()}
function rL(){return'<div class="loading-state"><div class="md-spinner"></div><p style="margin-top:24px">Loading...</p></div>'}
function rS(){return'<div class="center-page"><div class="auth-card"><h1>Welcome</h1><p class="subtitle">Create your admin account to get started.</p><div id="se"></div><div class="md-field"><label>Username</label><input id="su" type="text" placeholder="Choose a username"></div><div class="md-field"><label>Password</label><input id="sp" type="password" placeholder="Strong password"><div class="pw-check" id="pc"></div></div><div class="md-field"><label>Confirm password</label><input id="sp2" type="password" placeholder="Repeat password"></div><button class="md-filled-btn" id="sb" style="width:100%"><span class="material-icons-outlined" style="font-size:18px">person_add</span> Create account</button></div></div>'}
function rLi(){return'<div class="center-page"><div class="auth-card"><h1>Sign in</h1><p class="subtitle">Use your admin account to continue.</p><div id="le"></div><div class="md-field"><label>Username</label><input id="lu" type="text" placeholder="Username"></div><div class="md-field"><label>Password</label><input id="lp" type="password" placeholder="Password"></div><button class="md-filled-btn" id="lb" style="width:100%"><span class="material-icons-outlined" style="font-size:18px">login</span> Sign in</button></div></div>'}
function rTB(){var n=S.cfg.site_name||'Google Drive Index';var h='<div class="top-bar"><div class="brand"><span class="material-icons-outlined">cloud</span>'+E(n)+'</div>';if(S.cfg.allow_search!==false)h+='<div class="search-bar"><span class="material-icons-outlined">search</span><input id="ns" type="text" placeholder="Search in Drive" value="'+E(S.q)+'"></div>';else h+='<div class="spacer"></div>';if(S.auth)h+='<button class="icon-btn" id="na" title="Admin"><span class="material-icons-outlined">settings</span></button><button class="icon-btn" id="nl" title="Sign out"><span class="material-icons-outlined">logout</span></button>';else if(S.cfg.auth_enabled)h+='<button class="icon-btn" id="nli" title="Sign in"><span class="material-icons-outlined">login</span></button>';return h+'</div>'}
function rBC(){var h='<div class="breadcrumbs"><a href="#" data-bc="-1"><span class="material-icons-outlined" style="font-size:18px;vertical-align:middle">home</span> Home</a>';var seen={};S.stack.forEach(function(item,i){if(!seen[item.id]){seen[item.id]=1;h+='<span class="sep">\u203A</span>';if(i===S.stack.length-1)h+='<span class="current">'+E(item.name)+'</span>';else h+='<a href="#" data-bc="'+i+'">'+E(item.name)+'</a>'}});return h+'</div>'}
function rH(){var h=rTB()+'<div class="content">';if(!S.drives.length)return h+'<div class="empty-state"><span class="material-icons-outlined">inbox</span><h3 style="font-family:var(--md-sys-typescale-display-font);font-weight:400">No drives configured</h3><p>'+(S.auth?'Go to <a href="/admin">Admin Panel</a> to add drives.':'Contact the administrator.')+'</p></div></div>';if(S.folder==='root'&&!S.stack.length){h+='<div style="padding:8px 0 16px;font-size:14px;color:var(--md-sys-color-on-surface-variant)">Your drives</div><div class="drives-grid">';S.drives.forEach(function(d,i){h+='<div class="drive-card" data-dr="'+i+'"><div class="card-icon"><span class="material-icons-outlined">hard_drive</span></div><div class="card-text"><div class="card-title">'+E(d.name)+'</div><div class="card-sub">Google Drive</div></div></div>'});return h+'</div><div class="status-bar">'+S.drives.length+' drive(s)</div></div>'}h+=rBC();if(S.loading)return h+'<div class="loading-state"><div class="md-spinner"></div></div></div>';if(S.err)return h+'<div class="alert-error">'+E(S.err)+'</div></div>';if(!S.files.length)return h+'<div class="empty-state"><span class="material-icons-outlined">folder_open</span><h3 style="font-family:var(--md-sys-typescale-display-font);font-weight:400">Empty folder</h3></div></div>';h+='<div class="file-list"><div class="file-list-header"><div>Name</div><div>Size</div><div>Modified</div><div></div></div>';S.files.forEach(function(f,i){h+='<div class="file-row" data-fi="'+i+'"><div class="file-name">'+fI(f.mimeType,f.isFolder)+'<span>'+E(f.name)+'</span></div><div class="file-size">'+fSz(f.size)+'</div><div class="file-date">'+fDt(f.modifiedTime)+'</div><div>'+(f.isFolder?'':'<button class="icon-btn dlb" data-fi="'+i+'"><span class="material-icons-outlined" style="font-size:20px">download</span></button>')+'</div></div>'});h+='</div>';if(S.npt)h+='<div style="text-align:center;padding:20px"><button class="md-outlined-btn" id="lm">Load more</button></div>';return h+'<div class="status-bar">'+S.files.length+' item(s)</div></div>'}
function rSe(){var h=rTB()+'<div class="content"><div style="padding:8px 0 16px"><span style="color:var(--md-sys-color-on-surface-variant)">Results for</span> <strong>'+E(S.q)+'</strong></div>';if(S.loading)return h+'<div class="loading-state"><div class="md-spinner"></div></div></div>';if(S.err)return h+'<div class="alert-error">'+E(S.err)+'</div></div>';if(!S.sr.length)return h+'<div class="empty-state"><span class="material-icons-outlined">search_off</span><p>No results</p></div></div>';h+='<div class="file-list"><div class="file-list-header"><div>Name</div><div>Size</div><div>Drive</div><div></div></div>';S.sr.forEach(function(f,i){h+='<div class="file-row" data-si="'+i+'"><div class="file-name">'+fI(f.mimeType,f.isFolder)+'<span>'+E(f.name)+'</span></div><div class="file-size">'+fSz(f.size)+'</div><div class="file-date">'+E(f.driveName||'')+'</div><div>'+(f.isFolder?'':'<button class="icon-btn sdl" data-si="'+i+'"><span class="material-icons-outlined" style="font-size:20px">download</span></button>')+'</div></div>'});return h+'</div><div class="status-bar">'+S.sr.length+' result(s)</div></div>'}
function rAd(){if(!S.auth)return rLi();var h='<div class="admin-rail"><div class="rail-brand"><span class="material-icons-outlined">admin_panel_settings</span><span>Admin</span></div><nav>';var tabs=[['drives','hard_drive','Drives'],['config','tune','Config'],['password','key','Password']];tabs.forEach(function(t){h+='<a href="#" data-at="'+t[0]+'" class="'+(S.aTab===t[0]?'active':'')+'"><span class="material-icons-outlined">'+t[1]+'</span><span>'+t[2]+'</span></a>'});h+='</nav><div class="rail-footer"><a href="#" id="ab"><span class="material-icons-outlined" style="font-size:18px">arrow_back</span> <span>Back to site</span></a><br><a href="#" id="alo" style="color:var(--md-sys-color-error)"><span class="material-icons-outlined" style="font-size:18px">logout</span> <span>Sign out</span></a></div></div><div class="admin-body">';if(S.aTab==='drives')h+=rDrv();else if(S.aTab==='config')h+=rCfg();else if(S.aTab==='password')h+=rPwd();return h+'</div>'}
function rDrv(){var h='<h2><span class="material-icons-outlined">hard_drive</span> Drives</h2>';h+='<div style="margin-bottom:20px"><button class="md-filled-btn" id="tad">'+(S.showAdd?'<span class="material-icons-outlined" style="font-size:18px">close</span> Cancel':'<span class="material-icons-outlined" style="font-size:18px">add</span> Add drive')+'</button></div>';if(S.showAdd){h+='<div style="background:var(--md-sys-color-surface);border:1px solid var(--md-sys-color-outline-variant);border-radius:16px;padding:24px;margin-bottom:24px"><h3 style="font-family:var(--md-sys-typescale-display-font);font-weight:400;font-size:18px;margin-bottom:20px">New drive credentials</h3><div id="ae"></div>';h+='<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px"><div class="md-field"><label>Drive name</label><input id="an" type="text" placeholder="My Drive"></div><div class="md-field"><label>Root Folder ID</label><input id="ar" type="text" placeholder="root" value="root"></div></div>';h+='<div class="md-field"><label>Client ID</label><input id="ac" type="text" placeholder="xxxx.apps.googleusercontent.com"></div>';h+='<div class="md-field"><label>Client Secret</label><input id="as" type="password" placeholder="GOCSPX-xxxxx"></div>';h+='<div class="md-field"><label>Refresh Token</label><input id="at" type="password" placeholder="1//xxxxx"></div>';h+='<div style="display:flex;align-items:center;gap:12px;margin-bottom:20px"><input type="checkbox" id="ash" style="width:18px;height:18px"><label for="ash" style="font-size:14px">Shared Drive</label></div>';h+='<button class="md-filled-btn" id="ads"><span class="material-icons-outlined" style="font-size:18px">save</span> Save drive</button></div>'}if(!S.aDrives.length&&!S.showAdd){h+='<div class="empty-state"><span class="material-icons-outlined">inbox</span><p>No drives yet. Click "Add drive" above.</p></div>'}else if(S.aDrives.length){h+='<table class="md-table"><thead><tr><th>ID</th><th>Name</th><th>Root</th><th>Status</th><th></th></tr></thead><tbody>';S.aDrives.forEach(function(d){h+='<tr><td>'+d.id+'</td><td><strong>'+E(d.name)+'</strong></td><td><code style="font-size:12px;color:var(--md-sys-color-on-surface-variant)">'+E(d.root_folder_id)+'</code></td><td>'+(d.enabled?'<span class="chip-on">Enabled</span>':'<span class="chip-off">Disabled</span>')+'</td><td><button class="icon-btn dd" data-id="'+d.id+'"><span class="material-icons-outlined" style="font-size:18px;color:var(--md-sys-color-error)">delete</span></button></td></tr>'});h+='</tbody></table>'}return h}
function rCfg(){var h='<h2><span class="material-icons-outlined">tune</span> Configuration</h2>';var ks=Object.keys(S.aCfg).sort();if(!ks.length)return h+'<p style="color:var(--md-sys-color-on-surface-variant)">No config entries.</p>';h+='<table class="md-table"><thead><tr><th>Key</th><th>Value</th></tr></thead><tbody>';ks.forEach(function(k){h+='<tr><td><code>'+E(k)+'</code></td><td><input class="cv" data-key="'+E(k)+'" value="'+E(S.aCfg[k])+'" style="width:100%;padding:8px 12px;background:var(--md-sys-color-surface-container);border:1px solid var(--md-sys-color-outline-variant);border-radius:4px;color:var(--md-sys-color-on-surface);font-size:14px;outline:none"></td></tr>'});h+='</tbody></table><div style="margin-top:16px"><button class="md-filled-btn" id="sc"><span class="material-icons-outlined" style="font-size:18px">save</span> Save</button></div>';return h}
function rPwd(){return'<h2><span class="material-icons-outlined">key</span> Change Password</h2><div style="max-width:440px"><div id="pe"></div><div class="md-field"><label>Current password</label><input id="pc1" type="password" placeholder="Current password"></div><div class="md-field"><label>New password</label><input id="pn" type="password" placeholder="New password"></div><div class="md-field"><label>Confirm new password</label><input id="pn2" type="password" placeholder="Confirm"></div><button class="md-filled-btn" id="pcb"><span class="material-icons-outlined" style="font-size:18px">lock_reset</span> Update password</button></div>'}
function B(){var sb=$('#sb');if(sb)sb.onclick=function(){var u=$('#su').value.trim(),pw=$('#sp').value,p2=$('#sp2').value,e=$('#se');e.innerHTML='';if(!u||u.length<3){e.innerHTML='<div class="alert-error">Username min 3 chars</div>';return}if(pw!==p2){e.innerHTML='<div class="alert-error">Passwords don\'t match</div>';return}sb.disabled=true;api('setup',{method:'POST',body:JSON.stringify({username:u,password:pw})}).then(function(){e.innerHTML='<div class="alert-success">Created! Redirecting...</div>';setTimeout(function(){S.setupComplete=true;S.page='login';R()},1500)}).catch(function(x){e.innerHTML='<div class="alert-error">'+E(x.message)+'</div>';sb.disabled=false})};
var sp=$('#sp');if(sp)sp.oninput=function(){var v=sp.value,r=$('#pc');if(r)r.innerHTML=[v.length>=8?'<span class="ok">\u2713 8+</span>':'<span class="no">\u2717 8+</span>',/[A-Z]/.test(v)?'<span class="ok">\u2713 A-Z</span>':'<span class="no">\u2717 A-Z</span>',/[a-z]/.test(v)?'<span class="ok">\u2713 a-z</span>':'<span class="no">\u2717 a-z</span>',/[0-9]/.test(v)?'<span class="ok">\u2713 0-9</span>':'<span class="no">\u2717 0-9</span>',/[^A-Za-z0-9]/.test(v)?'<span class="ok">\u2713 !@#</span>':'<span class="no">\u2717 !@#</span>'].join(' ')};
var lb=$('#lb');if(lb){lb.onclick=function(){var u=$('#lu').value.trim(),p=$('#lp').value,e=$('#le');e.innerHTML='';if(!u||!p){e.innerHTML='<div class="alert-error">Enter credentials</div>';return}lb.disabled=true;api('login',{method:'POST',body:JSON.stringify({username:u,password:p})}).then(function(){S.auth=true;S.user=u;go('/');init()}).catch(function(x){e.innerHTML='<div class="alert-error">'+E(x.message)+'</div>';lb.disabled=false})};var lp=$('#lp');if(lp)lp.onkeydown=function(e){if(e.key==='Enter')lb.click()}}
$$('.drive-card,[data-dr]').forEach(function(c){c.onclick=function(){sD(+(c.dataset.dr||0))}});
$$('.file-row,[data-fi]').forEach(function(c){if(c.dataset.fi!==undefined)c.onclick=function(){var f=S.files[+c.dataset.fi];if(f&&f.isFolder)oF(f)}});
$$('.dlb').forEach(function(b){b.onclick=function(e){e.stopPropagation();var f=S.files[+b.dataset.fi];if(f)window.open('/download/'+S.di+'/'+f.id,'_blank')}});
$$('.sdl').forEach(function(b){b.onclick=function(e){e.stopPropagation();var f=S.sr[+b.dataset.si];if(f)window.open('/download/'+f.driveIndex+'/'+f.id,'_blank')}});
$$('[data-bc]').forEach(function(a){a.onclick=function(e){e.preventDefault();gT(+a.dataset.bc)}});
var lm=$('#lm');if(lm)lm.onclick=function(){lF()};
var ns=$('#ns');if(ns)ns.onkeydown=function(e){if(e.key==='Enter'&&ns.value.trim()){S.q=ns.value.trim();go('/search?q='+encodeURIComponent(S.q));dS()}};
var na=$('#na');if(na)na.onclick=function(){go('/admin')};
var nl=$('#nl');if(nl)nl.onclick=function(){api('logout',{method:'POST'}).catch(function(){});S.auth=false;S.user=null;init()};
var nli=$('#nli');if(nli)nli.onclick=function(){go('/login')};
$$('[data-at]').forEach(function(a){a.onclick=function(e){e.preventDefault();S.aTab=a.dataset.at;S.showAdd=false;R()}});
var ab=$('#ab');if(ab)ab.onclick=function(e){e.preventDefault();go('/')};
var alo=$('#alo');if(alo)alo.onclick=function(e){e.preventDefault();api('logout',{method:'POST'}).catch(function(){});S.auth=false;go('/login')};
var tad=$('#tad');if(tad)tad.onclick=function(){S.showAdd=!S.showAdd;R()};
var ads=$('#ads');if(ads)ads.onclick=function(){var n=$('#an').value.trim(),c=$('#ac').value.trim(),s=$('#as').value.trim(),t=$('#at').value.trim(),r=$('#ar').value.trim()||'root',sh=$('#ash').checked,ae=$('#ae');ae.innerHTML='';if(!n){ae.innerHTML='<div class="alert-error">Name required</div>';return}if(!c){ae.innerHTML='<div class="alert-error">Client ID required</div>';return}if(!s){ae.innerHTML='<div class="alert-error">Client Secret required</div>';return}if(!t){ae.innerHTML='<div class="alert-error">Refresh Token required</div>';return}ads.disabled=true;api('admin/drives',{method:'POST',body:JSON.stringify({name:n,client_id:c,client_secret:s,refresh_token:t,root_folder_id:r,is_shared_drive:sh})}).then(function(){S.showAdd=false;lA();api('status').then(function(d){S.drives=d.drives||[]}).catch(function(){})}).catch(function(e){ae.innerHTML='<div class="alert-error">'+E(e.message)+'</div>';ads.disabled=false})};
$$('.dd').forEach(function(b){b.onclick=function(){if(!confirm('Delete this drive?'))return;api('admin/drives?id='+b.dataset.id,{method:'DELETE'}).then(function(){lA()}).catch(function(e){alert(e.message)})}});
var sc=$('#sc');if(sc)sc.onclick=function(){var body={};$$('.cv').forEach(function(el){body[el.dataset.key]=el.value});api('admin/config',{method:'POST',body:JSON.stringify(body)}).then(function(){alert('Saved!')}).catch(function(e){alert(e.message)})};
var pcb=$('#pcb');if(pcb)pcb.onclick=function(){var c=$('#pc1').value,n=$('#pn').value,n2=$('#pn2').value,pe=$('#pe');pe.innerHTML='';if(!c||!n){pe.innerHTML='<div class="alert-error">All fields required</div>';return}if(n!==n2){pe.innerHTML='<div class="alert-error">New passwords don\'t match</div>';return}api('admin/password',{method:'POST',body:JSON.stringify({current_password:c,new_password:n})}).then(function(){pe.innerHTML='<div class="alert-success">Password updated. Please sign in again.</div>';setTimeout(function(){go('/login')},2000)}).catch(function(e){pe.innerHTML='<div class="alert-error">'+E(e.message)+'</div>'})}}
init();
})();