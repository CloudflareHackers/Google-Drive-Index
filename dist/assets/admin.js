// Admin Panel â€” Google Drive Index
(function(){
'use strict';
var S={auth:false,tab:'dashboard',dash:null,drives:[],creds:[],sa:[],cfg:{},showForm:false};
var $=function(s){return document.querySelector(s)};
var $$=function(s){return document.querySelectorAll(s)};
function E(s){return s==null?'':String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function api(p,o){o=o||{};var h=Object.assign({'Content-Type':'application/json'},o.headers||{});return fetch('/api/'+p,Object.assign({},o,{headers:h})).then(function(r){return r.json().then(function(d){if(!r.ok)throw new Error(d.error||'Failed');return d})})}
function toast(m,t){var c=$('#toasts');if(!c)return;var id='t'+Date.now();c.insertAdjacentHTML('beforeend','<div class="toast toast-'+(t||'success')+'" id="'+id+'">'+E(m)+'</div>');setTimeout(function(){var e=$('#'+id);if(e)e.remove()},3500)}
function init(){api('status').then(function(d){S.auth=!!d.authenticated;R();if(S.auth)loadTab()}).catch(function(){S.auth=false;R()})}
function loadTab(){S.showForm=false;if(S.tab==='dashboard')api('admin/dashboard').then(function(d){S.dash=d;R()}).catch(function(){});if(S.tab==='drives')api('admin/drives').then(function(d){S.drives=d.drives||[];R()}).catch(function(){});if(S.tab==='credentials')api('admin/credentials').then(function(d){S.creds=d.credentials||[];R()}).catch(function(){});if(S.tab==='sa')api('admin/service-accounts').then(function(d){S.sa=d.accounts||[];R()}).catch(function(){});if(S.tab==='config')api('admin/config').then(function(d){S.cfg=d.config||{};R()}).catch(function(){});if(S.tab==='security')R()}
function R(){var a=$('#app');if(!a)return;if(!S.auth){a.innerHTML=rLogin();B();return}a.innerHTML='<div class="toast-container" id="toasts"></div>'+rSB()+'<div class="main">'+rC()+'</div>';B()}
function rLogin(){return'<div class="login-page"><div class="login-card"><h1>Admin Login</h1><p>Sign in to manage your Drive Index</p><div id="le"></div><div class="form-group"><label>Username</label><input id="lu" type="text"></div><div class="form-group"><label>Password</label><input id="lp" type="password"></div><button class="btn btn-primary" id="lb" style="width:100%"><span class="material-icons-outlined" style="font-size:18px">login</span> Sign In</button></div></div>'}
function rSB(){var ts=[['dashboard','speed','Dashboard'],['credentials','badge','Credentials'],['drives','dns','Drives'],['config','tune','Configuration'],['sa','vpn_key','Service Accounts'],['security','shield','Security']];var h='<div class="sb"><div class="sb-brand"><span class="material-icons-outlined">settings</span><div><h2>Admin</h2><small>Drive Index</small></div></div><nav>';ts.forEach(function(t){h+='<a href="#" data-tab="'+t[0]+'" class="'+(S.tab===t[0]?'active':'')+'"><span class="material-icons-outlined">'+t[1]+'</span><span>'+t[2]+'</span></a>'});return h+'</nav><div class="sb-footer"><a href="/" target="_blank"><span class="material-icons-outlined" style="font-size:16px">open_in_new</span> <span>View Site</span></a><a href="#" class="logout" id="alo"><span class="material-icons-outlined" style="font-size:16px">logout</span> <span>Logout</span></a></div></div>'}
function rC(){switch(S.tab){case'dashboard':return rDash();case'credentials':return rCred();case'drives':return rDrv();case'config':return rCfg();case'sa':return rSA();case'security':return rSec();default:return''}}
function rDash(){var d=S.dash;if(!d)return'<h1><span class="material-icons-outlined">speed</span> Dashboard</h1><div class="empty"><span class="material-icons-outlined">hourglass_empty</span><p>Loading...</p></div>';var h='<h1><span class="material-icons-outlined">speed</span> Dashboard</h1><div class="stats"><div class="stat-card"><div><div class="stat-label">Drives</div><div class="stat-num">'+d.counts.drives+'</div></div><span class="material-icons-outlined">dns</span></div><div class="stat-card green"><div><div class="stat-label">Credentials</div><div class="stat-num">'+d.counts.credentials+'</div></div><span class="material-icons-outlined">badge</span></div><div class="stat-card yellow"><div><div class="stat-label">Service Accts</div><div class="stat-num">'+d.counts.service_accounts+'</div></div><span class="material-icons-outlined">vpn_key</span></div><div class="stat-card cyan"><div><div class="stat-label">Config</div><div class="stat-num">'+d.counts.config+'</div></div><span class="material-icons-outlined">tune</span></div></div>';h+='<div class="card"><div class="card-header">Overview</div><div class="card-body"><strong>Site:</strong> '+E(d.site_name);if(d.drives.length){h+='<hr style="border:0;border-top:1px solid var(--border);margin:12px 0">';d.drives.forEach(function(dr){h+='<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)"><span><span class="material-icons-outlined" style="font-size:16px;vertical-align:middle">dns</span> '+E(dr.name)+'</span><span><code>'+E(dr.root_folder_id)+'</code> '+(dr.auth_name?'<span class="badge badge-'+(dr.auth_type==='service_account'?'sa':'oauth')+'">'+E(dr.auth_name)+'</span>':'')+'</span></div>'})}h+='</div></div>';return h}
function rCred(){var h='<h1><span class="material-icons-outlined">badge</span> OAuth Credentials</h1><div style="margin-bottom:16px"><button class="btn btn-primary" id="tf"><span class="material-icons-outlined" style="font-size:18px">'+(S.showForm?'close':'add')+'</span> '+(S.showForm?'Cancel':'Add Credential')+'</button></div>';if(S.showForm){h+='<div class="card" style="margin-bottom:24px"><div class="card-header">New OAuth Credential</div><div class="card-body"><div id="fe"></div><div class="form-group"><label>Name</label><input id="cn" type="text" placeholder="e.g. My Google Account"></div><div class="form-group"><label>Client ID</label><input id="ci" type="text" placeholder="xxx.apps.googleusercontent.com"></div><div class="form-group"><label>Client Secret</label><input id="cs" type="password" placeholder="GOCSPX-xxx"></div><div class="form-group"><label>Refresh Token</label><input id="ct" type="password" placeholder="1//xxx"></div><button class="btn btn-primary" id="cf"><span class="material-icons-outlined" style="font-size:18px">save</span> Save</button></div></div>'}if(!S.creds.length&&!S.showForm){h+='<div class="card"><div class="card-body"><div class="empty"><span class="material-icons-outlined">badge</span><p>No credentials saved. Add OAuth credentials (client_id, secret, refresh_token).<br>Values are never displayed after saving.</p></div></div></div>'}else if(S.creds.length){h+='<div class="card"><div class="card-body p0"><table><thead><tr><th>#</th><th>Name</th><th>Created</th><th></th></tr></thead><tbody>';S.creds.forEach(function(c){h+='<tr><td>'+c.id+'</td><td><strong>'+E(c.name)+'</strong></td><td>'+E(c.created_at||'')+'</td><td><button class="icon-btn dc" data-id="'+c.id+'"><span class="material-icons-outlined" style="font-size:16px">delete</span></button></td></tr>'});h+='</tbody></table></div></div>'}return h}
function rDrv(){var h='<h1><span class="material-icons-outlined">dns</span> Drives</h1><div style="margin-bottom:16px"><button class="btn btn-primary" id="tf"><span class="material-icons-outlined" style="font-size:18px">'+(S.showForm?'close':'add')+'</span> '+(S.showForm?'Cancel':'Add Drive')+'</button></div>';if(S.showForm){h+='<div class="card" style="margin-bottom:24px"><div class="card-header">New Drive</div><div class="card-body"><div id="fe"></div><div class="form-row"><div class="form-group"><label>Drive Name</label><input id="dn" type="text" placeholder="My Drive"></div><div class="form-group"><label>Root Folder ID</label><input id="dr" type="text" value="root" placeholder="root or folder ID"></div></div><div class="form-row"><div class="form-group"><label>Auth Type</label><select id="da"><option value="oauth">OAuth Credential</option><option value="service_account">Service Account</option></select></div><div class="form-group"><label>Credential / SA</label><select id="dc"><option value="">-- Select --</option></select></div></div><div class="form-check"><input type="checkbox" id="ds"><label for="ds">Shared Drive</label></div><button class="btn btn-primary" id="df"><span class="material-icons-outlined" style="font-size:18px">save</span> Save Drive</button></div></div>'}if(!S.drives.length&&!S.showForm){h+='<div class="card"><div class="card-body"><div class="empty"><span class="material-icons-outlined">dns</span><p>No drives configured.</p></div></div></div>'}else if(S.drives.length){h+='<div class="card"><div class="card-body p0"><table><thead><tr><th>#</th><th>Name</th><th>ID</th><th>Auth</th><th>Status</th><th></th></tr></thead><tbody>';S.drives.forEach(function(d,i){h+='<tr><td>'+i+'</td><td><strong>'+E(d.name)+'</strong></td><td><code>'+E(d.root_folder_id)+'</code></td><td><span class="badge badge-'+(d.auth_type==='service_account'?'sa':'oauth')+'">'+(d.auth_type==='service_account'?'SA':'OAuth')+'</span></td><td>'+(d.enabled?'<span class="badge badge-on">On</span>':'<span class="badge badge-off">Off</span>')+'</td><td><button class="icon-btn dd" data-id="'+d.id+'"><span class="material-icons-outlined" style="font-size:16px">delete</span></button></td></tr>'});h+='</tbody></table></div></div>'}return h}
function rCfg(){var h='<h1><span class="material-icons-outlined">tune</span> Configuration</h1>';var ks=Object.keys(S.cfg).sort();if(!ks.length)return h+'<div class="card"><div class="card-body"><div class="empty"><span class="material-icons-outlined">tune</span><p>No config.</p></div></div></div>';h+='<div class="card"><div class="card-body p0"><table><thead><tr><th>Key</th><th>Value</th></tr></thead><tbody>';ks.forEach(function(k){h+='<tr><td><code>'+E(k)+'</code></td><td><input class="cv" data-key="'+E(k)+'" value="'+E(S.cfg[k])+'" style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:6px;background:var(--surface);color:var(--text);font-size:14px;outline:none"></td></tr>'});h+='</tbody></table></div></div><button class="btn btn-primary" id="sc"><span class="material-icons-outlined" style="font-size:18px">save</span> Save Changes</button>';return h}
function rSA(){var h='<h1><span class="material-icons-outlined">vpn_key</span> Service Accounts</h1><div style="margin-bottom:16px"><button class="btn btn-primary" id="tf"><span class="material-icons-outlined" style="font-size:18px">'+(S.showForm?'close':'add')+'</span> '+(S.showForm?'Cancel':'Add Service Account')+'</button></div>';if(S.showForm){h+='<div class="card" style="margin-bottom:24px"><div class="card-header">Add Service Account</div><div class="card-body"><div id="fe"></div><div class="form-group"><label>Service Account JSON</label><textarea id="sj" rows="10" placeholder="Paste the full service account JSON key file here..." style="font-family:monospace;font-size:12px"></textarea></div><button class="btn btn-primary" id="sf"><span class="material-icons-outlined" style="font-size:18px">save</span> Save</button></div></div>'}if(!S.sa.length&&!S.showForm){h+='<div class="card"><div class="card-body"><div class="empty"><span class="material-icons-outlined">vpn_key</span><p>No service accounts.</p></div></div></div>'}else if(S.sa.length){h+='<div class="card"><div class="card-body p0"><table><thead><tr><th>#</th><th>Name</th><th>Status</th><th></th></tr></thead><tbody>';S.sa.forEach(function(s){h+='<tr><td>'+s.id+'</td><td>'+E(s.name)+'</td><td>'+(s.enabled?'<span class="badge badge-on">On</span>':'<span class="badge badge-off">Off</span>')+'</td><td><button class="icon-btn dsa" data-id="'+s.id+'"><span class="material-icons-outlined" style="font-size:16px">delete</span></button></td></tr>'});h+='</tbody></table></div></div>'}return h}
function rSec(){return'<h1><span class="material-icons-outlined">shield</span> Security</h1><div class="card"><div class="card-header">Change Admin Password</div><div class="card-body"><div id="pe"></div><div class="form-row"><div class="form-group"><label>Current Password</label><input id="pc" type="password"></div><div class="form-group"><label>New Password</label><input id="pn" type="password"></div></div><div class="form-group"><label>Confirm New Password</label><input id="pn2" type="password"></div><button class="btn btn-primary" id="pb"><span class="material-icons-outlined" style="font-size:18px">lock_reset</span> Update Password</button></div></div>'}
function B(){var lb=$('#lb');if(lb){lb.onclick=function(){var u=$('#lu').value.trim(),p=$('#lp').value,e=$('#le');e.innerHTML='';if(!u||!p){e.innerHTML='<div class="alert alert-error">Enter credentials</div>';return}lb.disabled=true;api('login',{method:'POST',body:JSON.stringify({username:u,password:p})}).then(function(){S.auth=true;R();loadTab()}).catch(function(x){e.innerHTML='<div class="alert alert-error">'+E(x.message)+'</div>';lb.disabled=false})};var lp=$('#lp');if(lp)lp.onkeydown=function(e){if(e.key==='Enter')lb.click()}}
$$('[data-tab]').forEach(function(a){a.onclick=function(e){e.preventDefault();S.tab=a.dataset.tab;S.showForm=false;R();loadTab()}});
var alo=$('#alo');if(alo)alo.onclick=function(e){e.preventDefault();api('logout',{method:'POST'}).catch(function(){});S.auth=false;R()};
var tf=$('#tf');if(tf)tf.onclick=function(){S.showForm=!S.showForm;R();if(S.showForm&&S.tab==='drives')populateDriveSelects()};
var cf=$('#cf');if(cf)cf.onclick=function(){var n=$('#cn').value.trim(),ci=$('#ci').value.trim(),cs=$('#cs').value.trim(),ct=$('#ct').value.trim(),fe=$('#fe');fe.innerHTML='';if(!n||!ci||!cs||!ct){fe.innerHTML='<div class="alert alert-error">All fields required</div>';return}cf.disabled=true;api('admin/credentials',{method:'POST',body:JSON.stringify({name:n,client_id:ci,client_secret:cs,refresh_token:ct})}).then(function(){S.showForm=false;toast('Credential saved');loadTab()}).catch(function(x){fe.innerHTML='<div class="alert alert-error">'+E(x.message)+'</div>';cf.disabled=false})};
$$('.dc').forEach(function(b){b.onclick=function(){if(!confirm('Delete this credential?'))return;api('admin/credentials?id='+b.dataset.id,{method:'DELETE'}).then(function(){toast('Deleted');loadTab()}).catch(function(x){toast(x.message,'error')})}});
var df=$('#df');if(df)df.onclick=function(){var n=$('#dn').value.trim(),r=$('#dr').value.trim()||'root',at=$('#da').value,cid=$('#dc').value,sh=$('#ds').checked,fe=$('#fe');fe.innerHTML='';if(!n){fe.innerHTML='<div class="alert alert-error">Name required</div>';return}df.disabled=true;api('admin/drives',{method:'POST',body:JSON.stringify({name:n,root_folder_id:r,auth_type:at,credential_id:cid?+cid:null,is_shared_drive:sh})}).then(function(){S.showForm=false;toast('Drive added');loadTab()}).catch(function(x){fe.innerHTML='<div class="alert alert-error">'+E(x.message)+'</div>';df.disabled=false})};
$$('.dd').forEach(function(b){b.onclick=function(){if(!confirm('Delete?'))return;api('admin/drives?id='+b.dataset.id,{method:'DELETE'}).then(function(){toast('Deleted');loadTab()}).catch(function(x){toast(x.message,'error')})}});
var sc=$('#sc');if(sc)sc.onclick=function(){var body={};$$('.cv').forEach(function(el){body[el.dataset.key]=el.value});api('admin/config',{method:'POST',body:JSON.stringify(body)}).then(function(){toast('Config saved')}).catch(function(x){toast(x.message,'error')})};
var sf=$('#sf');if(sf)sf.onclick=function(){var j=$('#sj').value.trim(),fe=$('#fe');fe.innerHTML='';if(!j){fe.innerHTML='<div class="alert alert-error">Paste JSON</div>';return}try{JSON.parse(j)}catch(e){fe.innerHTML='<div class="alert alert-error">Invalid JSON</div>';return}sf.disabled=true;api('admin/service-accounts',{method:'POST',body:JSON.stringify({json_data:j})}).then(function(){S.showForm=false;toast('Service account added');loadTab()}).catch(function(x){fe.innerHTML='<div class="alert alert-error">'+E(x.message)+'</div>';sf.disabled=false})};
$$('.dsa').forEach(function(b){b.onclick=function(){if(!confirm('Delete?'))return;api('admin/service-accounts?id='+b.dataset.id,{method:'DELETE'}).then(function(){toast('Deleted');loadTab()}).catch(function(x){toast(x.message,'error')})}});
var pb=$('#pb');if(pb)pb.onclick=function(){var c=$('#pc').value,n=$('#pn').value,n2=$('#pn2').value,pe=$('#pe');pe.innerHTML='';if(!c||!n){pe.innerHTML='<div class="alert alert-error">All fields required</div>';return}if(n!==n2){pe.innerHTML='<div class="alert alert-error">Passwords don\'t match</div>';return}api('admin/password',{method:'POST',body:JSON.stringify({current_password:c,new_password:n})}).then(function(){pe.innerHTML='<div class="alert alert-success">Updated! Please log in again.</div>';setTimeout(function(){S.auth=false;R()},2000)}).catch(function(x){pe.innerHTML='<div class="alert alert-error">'+E(x.message)+'</div>'})}}
function populateDriveSelects(){var sel=$('#dc');if(!sel)return;sel.innerHTML='<option value="">-- None (use drive creds) --</option>';if($('#da').value==='service_account'){S.sa.forEach(function(s){sel.innerHTML+='<option value="'+s.id+'">'+E(s.name)+'</option>'})}else{S.creds.forEach(function(c){sel.innerHTML+='<option value="'+c.id+'">'+E(c.name)+'</option>'})};var da=$('#da');if(da)da.onchange=function(){populateDriveSelects()}}
init();
})();